---
import '../styles/global.css'
import {
  locales,
  getLangFromUrl,
  useTranslations,
  getLocalizedPath,
  getPathForLocale,
  localeInfo,
  type Locale
} from '../lib/i18n'

interface Props {
  title: string
  description?: string
  image?: string
  type?: 'website' | 'article'
  publishDate?: Date
}

const {
  title,
  description = 'Gharis Primada Hariyono',
  image = '/og-default.png',
  type = 'website',
  publishDate
} = Astro.props

const lang = getLangFromUrl(Astro.url)
const t = useTranslations(lang)
const currentInfo = localeInfo[lang]

const canonicalURL = new URL(Astro.url.pathname, Astro.site)
const socialImageURL = new URL(image, Astro.site)
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />

    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalURL} />

    <!-- Primary Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={type} />
    <meta property="og:url" content={Astro.url} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={socialImageURL} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={Astro.url} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={socialImageURL} />

    {
      publishDate && (
        <meta
          property="article:published_time"
          content={publishDate.toISOString()}
        />
      )
    }
  </head><body class="selection:bg-orange-500/20">
    <div class="noise-bg"></div>

    <nav
      class="fixed top-0 left-0 w-full z-40 p-6 mix-blend-difference text-mist pointer-events-none"
    >
      <div
        class="max-w-7xl mx-auto flex justify-between items-start pointer-events-auto"
      >
        <a
          href={getLocalizedPath('/', lang)}
          class="text-xl font-bold tracking-tighter hover:tracking-widest transition-all duration-700 ease-squish"
        >
          gphariyono
        </a>
        <div class="flex items-center gap-6">
          <div class="flex flex-col gap-2 text-right text-sm font-mono">
            <a
              href={getLocalizedPath('/essays', lang)}
              class="hover:text-accent transition-colors"
            >
              {t('nav.essays')}
            </a>
            <a
              href={getLocalizedPath('/fragments', lang)}
              class="hover:text-accent transition-colors translate-x-2"
            >
              {t('nav.fragments')}
            </a>
          </div>

          <!-- Language Dropdown -->
          <div class="relative" id="locale-dropdown">
            <button
              type="button"
              id="locale-toggle"
              class="flex items-center gap-1.5 text-sm font-mono text-mist/60 hover:text-accent transition-colors cursor-pointer px-2 py-1 rounded-md hover:bg-mist/5"
              aria-label="Change language"
              aria-expanded="false"
              aria-haspopup="listbox"
            >
              <span class="text-base leading-none">{currentInfo.flag}</span>
              <span class="text-xs uppercase">{lang}</span>
              <svg class="w-3 h-3 opacity-50 transition-transform duration-200" id="locale-chevron" viewBox="0 0 12 12" fill="none">
                <path d="M3 5L6 8L9 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            </button>

            <div
              id="locale-menu"
              class="absolute right-0 top-full mt-2 min-w-[160px] rounded-lg border border-mist/10 bg-void/95 backdrop-blur-md shadow-xl opacity-0 invisible translate-y-1 transition-all duration-200 z-50 mix-blend-normal isolate"
              role="listbox"
              aria-label="Select language"
            >
              {
                locales.map(loc => {
                  const info = localeInfo[loc]
                  const isActive = loc === lang
                  return (
                    <a
                      href={getPathForLocale(Astro.url, loc)}
                      role="option"
                      aria-selected={isActive}
                      class:list={[
                        'flex items-center gap-3 px-4 py-2.5 text-sm font-mono transition-colors first:rounded-t-lg last:rounded-b-lg',
                        isActive
                          ? 'text-accent bg-accent/5'
                          : 'text-mist/60 hover:text-mist hover:bg-mist/5'
                      ]}
                    >
                      <span class="text-base leading-none">{info.flag}</span>
                      <span>{info.label}</span>
                      {isActive && <span class="ml-auto text-accent text-xs">âœ“</span>}
                    </a>
                  )
                })
              }
            </div>
          </div>
        </div>
      </div>
    </nav>

    <main class="relative z-10 min-h-screen px-6 pt-32 pb-20 max-w-7xl mx-auto">
      <slot />
    </main>

    <script>
      const toggle = document.getElementById('locale-toggle')
      const menu = document.getElementById('locale-menu')
      const chevron = document.getElementById('locale-chevron')

      function openMenu() {
        menu?.classList.remove('opacity-0', 'invisible', 'translate-y-1')
        menu?.classList.add('opacity-100', 'visible', 'translate-y-0')
        chevron?.classList.add('rotate-180')
        toggle?.setAttribute('aria-expanded', 'true')
      }

      function closeMenu() {
        menu?.classList.add('opacity-0', 'invisible', 'translate-y-1')
        menu?.classList.remove('opacity-100', 'visible', 'translate-y-0')
        chevron?.classList.remove('rotate-180')
        toggle?.setAttribute('aria-expanded', 'false')
      }

      toggle?.addEventListener('click', (e) => {
        e.stopPropagation()
        const isOpen = toggle.getAttribute('aria-expanded') === 'true'
        isOpen ? closeMenu() : openMenu()
      })

      document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('locale-dropdown')
        if (!dropdown?.contains(e.target as Node)) closeMenu()
      })

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeMenu()
      })
    </script>
  </body>
</html>
