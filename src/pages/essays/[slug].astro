---
import { getCollection, type CollectionEntry } from 'astro:content'
import Layout from '../../layouts/Layout.astro'
import TableOfContents from '../../components/TableOfContents'

export async function getStaticPaths() {
  const essays = (await getCollection('essays')) as CollectionEntry<'essays'>[]
  return essays.map(entry => ({
    params: { slug: entry.slug },
    props: { entry }
  }))
}

interface Props {
  entry: CollectionEntry<'essays'>
}

const { entry } = Astro.props
const { Content, headings } = await entry.render()

const wordCount = entry.body.split(/\s+/g).length
const readTime = Math.ceil(wordCount / 200)

const ogImage = new URL(`/essays/og/${entry.slug}.png`, Astro.url)
---

<Layout
  title={entry.data.title}
  description={entry.data.description}
  image={ogImage.toString()}
  type="article"
  publishDate={entry.data.publishDate}
>
  <article class="grid grid-cols-1 lg:grid-cols-12 gap-8 relative">
    <aside class="hidden lg:block lg:col-span-2">
      <!-- Left gutter, maybe for references later -->
      <div
        class="rotate-90 origin-top-left translate-y-24 text-xs font-mono text-mist/30"
      >
        {entry.data.publishDate.toISOString().split('T')[0]}
      </div>
    </aside>

    <div
      class="lg:col-span-8 prose prose-invert prose-lg prose-p:font-sans prose-headings:font-bold prose-headings:tracking-tighter max-w-none flex flex-col gap-6"
    >
      <header class="not-prose flex flex-col gap-6">
        <h1 class="text-5xl md:text-7xl font-black tracking-tighter">
          {entry.data.title}
        </h1>
        <div
          class="flex flex-wrap gap-4 items-center text-sm font-mono text-mist/50"
        >
          {entry.data.tags.map(tag => <span class="text-accent">#{tag}</span>)}
          <span class="w-1 h-1 rounded-full bg-mist/20"></span>
          <span>{readTime} min read</span>
        </div>
      </header>

      <Content />
    </div>

    <aside class="hidden lg:block lg:col-span-2 relative">
      <TableOfContents headings={headings} client:media="(min-width: 1024px)" />
    </aside>
  </article>
</Layout>
